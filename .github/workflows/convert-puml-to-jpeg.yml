name: Convert PlantUML to JPEG

on:
  workflow_dispatch:
    inputs:
      output_folder:
        description: 'Output folder containing .puml files'
        required: false
        default: 'output'
        type: string
      commit_changes:
        description: 'Commit generated images to repository'
        required: false
        default: true
        type: boolean

jobs:
  convert-puml:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Install PlantUML
      run: |
        echo "ğŸ“¦ Installing PlantUML..."
        sudo apt-get update
        sudo apt-get install -y plantuml default-jre
        
    - name: Install ImageMagick
      run: |
        echo "ğŸ“¦ Installing ImageMagick for JPEG conversion..."
        sudo apt-get install -y imagemagick
        
    - name: Verify installations
      run: |
        echo "ğŸ” Verifying installations..."
        plantuml -version
        convert -version
        
    - name: List .puml files
      run: |
        echo "ğŸ“ Listing .puml files in ${{ github.event.inputs.output_folder || 'output' }} directory:"
        find ${{ github.event.inputs.output_folder || 'output' }} -name "*.puml" -type f || echo "No .puml files found"
        
    - name: Run picgen.sh script
      run: |
        echo "ğŸš€ Running PlantUML to JPEG conversion..."
        chmod +x ./picgen.sh
        ./picgen.sh
        
        # Check if any images were actually generated
        echo "ğŸ” Checking for generated images after script execution..."
        if find output -name "*.jpg" -o -name "*.png" | grep -q .; then
          echo "âœ… Images were generated successfully"
        else
          echo "âš ï¸ No images were generated. This might indicate an issue with the conversion process."
        fi
        
    - name: List generated images
      run: |
        echo "ğŸ“ Generated images in output directory:"
        find output -name "*.jpg" -o -name "*.png" | sort || echo "No images found"
        
        echo "ğŸ“ All files in output directory:"
        ls -la output/
        
        echo "ğŸ“ Checking if images exist with exact paths:"
        for ext in jpg png; do
          echo "Checking for *.$ext files:"
          ls -la output/*.$ext 2>/dev/null || echo "No .$ext files found"
        done
        
        echo "ğŸ“Š Summary of files in output directory:"
        echo "Total files: $(find output -type f | wc -l)"
        echo "PNG files: $(find output -name "*.png" | wc -l)"
        echo "JPG files: $(find output -name "*.jpg" | wc -l)"
        echo "PUML files: $(find output -name "*.puml" | wc -l)"
        
        echo "ğŸ” Verifying JPG files for upload:"
        jpg_files=$(find output -name "*.jpg")
        if [ -n "$jpg_files" ]; then
          echo "âœ… Found JPG files to upload:"
          echo "$jpg_files"
        else
          echo "âŒ No JPG files found for upload"
        fi
        
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes to commit"
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changes detected, will commit if enabled"
        fi
        
    - name: Commit and push changes
      if: ${{ github.event.inputs.commit_changes != 'false' && steps.check_changes.outputs.no_changes != 'true' }}
      run: |
        echo "ğŸ“ Committing generated images to repository..."
        
        # Add all generated images
        git add output/*.jpg output/*.png 2>/dev/null || echo "No new images to add"
        
        # Check if there are staged changes
        if git diff --cached --quiet; then
          echo "â„¹ï¸ No staged changes to commit"
        else
          # Create commit message
          COMMIT_MSG="ğŸ–¼ï¸ Auto-generate PlantUML images from .puml files"
          
          # Add details about which files were converted
          echo "" >> /tmp/commit_msg
          echo "Generated from:" >> /tmp/commit_msg
          find output -name "*.puml" -exec basename {} \; | sed 's/^/- /' >> /tmp/commit_msg
          echo "" >> /tmp/commit_msg
          echo "Generated images:" >> /tmp/commit_msg
          find output -name "*.jpg" -o -name "*.png" | sort | sed 's/^/- /' >> /tmp/commit_msg
          
          # Commit with detailed message
          git commit -F /tmp/commit_msg
          
          # Push to the same branch
          git push origin ${{ github.ref }}
          
          echo "âœ… Successfully committed and pushed generated images"
        fi
        
    - name: Skip commit (disabled by user)
      if: ${{ github.event.inputs.commit_changes == 'false' }}
      run: |
        echo "â­ï¸ Skipping commit as requested by user"
        
    - name: Upload generated images as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: plantuml-images
        path: output/*.jpg
        retention-days: 30